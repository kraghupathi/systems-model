#+Title: Common Vars Role
#+Date: April 14, 2015. Tuesday
#+PROPERTY: session *scratch*
#+PROPERTY: results output
#+PROPERTY: exports code
#+OPTIONS: ^:nil
#+SETUPFILE: org-templates/level-0.org

* Introduction
  The document describes the requirements, design and implementation
  of the "common_vars" ansible role. "common_vars" role defines common
  variables used by the jinja2 templates in various other ansible
  roles. Examples and verification are given wherever possible.
  
  In ansible we can define variables in the =role/vars/main.yml=
  file. The variables used by a role are mentioned in this file. Some
  variables are common across several roles. When the value of such a
  common variable changes, it has to be changed in the
  =role/vars/main.yml= file of all the roles. To avoid this
  redundancy, such common variables are defined in the "common_vars"
  role. This allows us to update the variables value at a single
  location i.e. =common_vars/vars/main.yml= file, and all the roles
  then use the updated value.

* Requirements
  The functional requirements of the common-vars role are mentioned in
  the following sections.

** Functional Requirements
   Define variables used by various other ansible roles.

* Implementation
** Structure of the scripts
   The implementation of this system is in terms of a collection of
   ansible scripts that configure the machine. These scripts are
   organized in the following way:

#+BEGIN_EXAMPLE
|-code
|   |-- common_vars.yml
|   |-- roles
|   |   |-- common_vars
|   |   |   `-- vars
|   |   |   |   `-- main.yml
#+END_EXAMPLE
   
   Here =common_vars.yml= file is a main playbook to configure nodes
   in the cluster.
   
   =roles/common_vars/vars/main.yml= file defines the variables used
   by various other ansible playbooks. Variables value in ansible
   playbook is imported from this common_vars file.

** Common Variables
*** Variable Description

|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
| S.no | Variable                  | Variable Name             | Description                                                                  |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   1. | Proxy Environment         | proxy_env                 | Defines the proxy configuration in case direct access                        |
|      |                           |                           | to internet is not available                                                 |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   2. | HTTP Proxy                | http_proxy                | Defines url of proxy server used by nodes to connect to                      |
|      |                           |                           | http service for internet access                                             |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   3. | HTTPS Proxy               | https_proxy               | Defines url of proxy server used by nodes to connect to https                |
|      |                           |                           | service for internet access                                                  |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   4. | Ansible Server IPs        | ansible_server_ips        | Defines the list of ip-addresses of ansible server                           |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   5. | Management IPs            | managements_ips           | Defines the list of ip-addresses of various management servers               |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   6. | Ossec Server IP           | ossec_server_ip           | Defines the ip-address of ossec server                                       |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   7. | Ossec Client IP           | ossec_client_ips          | Defines the ip address of various ossec clients                              |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   8. | Admin Email Address       | admin_email_addres        | Defines the email address of the system administrator                        |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|   9. | SMTP Smart host           | smtp_smart_host           | Defines the SMTP smart host via which various servers can send               |
|      |                           |                           | email and also Defines the SMTP server's address through which administrator |
|      |                           |                           | Defines the SMTP server's address trough which administrator                 |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  10. | Private DNS IPs           | private_dns_ips           | Defines the ip address of private DNS server, to configure it                |
|      |                           |                           | on all the client machines                                                   |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  11. | Private DNS zone          | private_dns_zone          | Defines the various dns zones                                                |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  12. | Rsyslog Server IP         | rsyslog_server_ips        | Defines the ip address of rsyslog server                                     |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  13. | Virtual Hosts FQDN        | proxy_domains             | Defines list of FQDNs for which virtual hosts are defined                    |
|      |                           |                           | in reverse proxy server                                                      |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  14. | Awstat Domain             | awstats_domains           | Defines list of domain for which analytics is to be collected                |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  15. | ADS IP                    | ads_ip                    | Defines the ip address of Auto deployment server                             |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  16. | Reverse Proxy IP          | reverseproxy_ip           | Defines the ip address of reverse proxy server                               |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  17. | Public DNS IP             | public_dns_ip             | Defines the ip address of public dns server                                  |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  18. | Local Subnet              | local_subnet              | Defines the local subnet                                                     |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  19. | Router Interface IP       | router_interface_ip       | Defines the interface of router node                                         |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  20. | Router External Interface | router_external_interface | Defines the external interface of router node                                |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  21. | Nagios Server IP          | nagios_server_ips         | Defines the ip address of nagios server                                      |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  22. | Release Number            | release_no                | Defines the release version of the configuration files using                 |
|      |                           |                           | which nodes in the cluster are configured                                    |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|
|  23. | Cluster Name              | prefix                    | Defines the cluster name                                                     |
|------+---------------------------+---------------------------+------------------------------------------------------------------------------|

*** Variable Value

|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
| S.no | Variable Name             | Single/Multiple Value | Variable Type | Value                                      | Value Description                       |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   1. | proxy_env                 | Multiple              | {Key:Value}   | http_proxy                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       |               | https_proxy                                |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   2. | http_proxy                | Single                | FQDN and port | http://proxy.iiit.ac.in:8080/              |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   3. | https_proxy               | Single                | FQDN and port | http://proxy.iiit.ac.in:8080/              |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   4. | ansible_server_ips        | Multiple              | IPAddress     | 10.100.1.2                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   5. | managements_ips           | Multiple              | IPAddress     | 14.139.82.6/32                             | NKN ISP                                 |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 196.12.53.133/32                           | STPI ISP                                |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   6. | ossec_server_ip           | Single                | IPAddress     | 10.100.1.3                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   7. | ossec_client_ips          | Multiple              | IPAddress     | 10.100.1.1                                 | Router                                  |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.2                                 | Ansible                                 |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.4                                 | Rsyslog Server                          |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.5                                 | Private DNS                             |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.6                                 | Public DNS                              |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.7                                 | Reverse Proxy                           |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | IPAddress     | 10.100.1.8                                 | Nagios                                  |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|   8. | admin_email_addres        | Single                | Email Address | alerts@vlabs.ac.in                         |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  09. | smtp_smart_host           | Single                | FQDN          | none                                       |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  10. | private_dns_ips           | Multiple              | IPAddress     | 10.100.1.5                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  11. | private_dns_zone          | Multiple              | Domain Name   | virtual-labs.ac.in                         |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | Domain Name   | vlabs.ac.in                                |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  12. | rsyslog_server_ips        | Multiple              | IPAddress     | 10.100.1.4                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  13. | proxy_domains             | Multiple              | List of       | {                                          | Virtual Host domain and alias           |
|      |                           |                       | {Key: Value}  | domain: "reverseproxy.virtual-labs.ac.in", | for Reverse Proxy server.               |
|      |                           |                       |               | alias: "reverseproxy.vlabs.ac.in",         |                                         |
|      |                           |                       |               | alias2: "rp.virtual-labs.ac.in"            |                                         |
|      |                           |                       |               | }                                          |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       |               | {                                          | Virtual Host domain and alias           |
|      |                           |                       |               | domain: "lab1.virtual-labs.ac.in",         | for lab1.                               |
|      |                           |                       |               | alias: "lab1.vlabs.ac.in"                  |                                         |
|      |                           |                       |               | }                                          |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       |               | {                                          | Virtual Host domain and alias           |
|      |                           |                       |               | domain: "lab2.virtual-labs.ac.in",         | for lab2.                               |
|      |                           |                       |               | alias: "lab2.vlabs.ac.in"                  |                                         |
|      |                           |                       |               | }                                          |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       |               | {                                          | Virtual Host domain and alias           |
|      |                           |                       |               | domain: "nagios.virtual-labs.ac.in",       | for nagios server.                      |
|      |                           |                       |               | alias: "nagios.vlabs.ac.in"                |                                         |
|      |                           |                       |               | }                                          |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       |               | {                                          | Virtual Host domain and alias           |
|      |                           |                       |               | domain: "ossec-server.virtual-labs.ac.in", | for ossec server.                       |
|      |                           |                       |               | alias: "ossec-server.vlabs.ac.in"          |                                         |
|      |                           |                       |               | }                                          |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  14. | awstats_domains           | Multiple              | FQDN          | reverseproxy.virtual-labs.ac.in            |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | FQDN          | lab1.virtual-labs.ac.in                    |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|      |                           |                       | FQDN          | lab2.virtual-labs.ac.in                    |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  15. | ads_ip                    | Single                | IPAddress     | 127.0.0.1                                  |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  16. | reverseproxy_ip           | Single                | IPAddress     | 10.100.1.7                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  17. | public_dns_ip             | Single                | IPAddress     | 10.100.1.6                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  18. | local_subnet              | Single                | IPAddress     | 10.100.0.0/22                              |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  19. | router_interface_ip       | Single                | IPAddress     | 10.100.1.1                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  20. | router_external_interface | Single                | Interface     | eth0                                       |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  21. | nagios_server_ips         | Single                | IPAddress     | 10.100.1.8                                 |                                         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  22. | release_no                | Single                | Integer       | 0                                          | Present version of the configuration    |
|      |                           |                       |               |                                            | file is - 0th. Which is the very first  |
|      |                           |                       |               |                                            | version of configuration files.         |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|
|  23. | prefix                    | Multiple              | String        | ""(empty), "base1.", "base4."              | For AWS value of variable is empty,     |
|      |                           |                       |               |                                            | for base1 cluster values of variable    |
|      |                           |                       |               |                                            | is "base1." and for base4 cluster value |
|      |                           |                       |               |                                            | of variable is "base4."                 |
|------+---------------------------+-----------------------+---------------+--------------------------------------------+-----------------------------------------|

** Generate yml files of common_vars role
   Generate common_vars role ".yml" file with all the variables defined.
   There are three separate "common_vars" file for each cluster. One
   is for AWS cluster, one is for base1 cluster and one is for base4
   cluster.

   The value of variables such as "zone_names" in the roles depend on
   the cluster which is setup. For example the FQDN of cse05 lab
   hosted on base1 cluster is "cse05.base1.virtual-labs.ac.in" and the
   FQDN of the same lab hosted on AWS cluster is
   "cse05.virtual-labs.ac.in".

*** Variables for Cluster setup
Variables for cluster are defined in the following section

#+BEGIN_SRC yml :tangle roles/common_vars/vars/main.yml
---
#Proxy configuration in case direct access to Internet is not available
proxy_env:
  none: none
# http_proxy: http://proxy.iiit.ac.in:8080/
# https_proxy: http://proxy.iiit.ac.in:8080/

#Release number used in common task to add it to the target
release_no:
 - 00

#prefix varible used in almost all ansible script. This variable is used to set the cluster name
prefix: ""

#List of ansible servers.  Mutliple ansible servers are fine
ansible_server_ips: 
  - 10.100.1.2

#Anlytics IP used by RP role to rsync logs,awstats
analytics_server_ip: 10.100.1.12

#Ads Ip used by lab role
ads_ip: 10.100.1.9

#List of rsnapshot servers.
rsnapshot_server_ips: 
  - 10.100.1.10

#AWS remote/secondary backup used by rsnapshot role
aws_backup: 196.12.53.133

#List of management stations.  Multiple is ok
management_ips:
  - 14.139.82.6/32
  - 196.12.53.133/32

public_zone_address: 
ansible_external_ip: 

#OSSEC server IP.  Only one
ossec_server_ip: 10.100.1.3

#OSSEC client IPs.  Multiple is ok.
ossec_client_ips: 
#For some reasons {{ansible_default_ipv4.address}} on ansible and router is resolving
#to 10.4.12.0/22 IPs and not to 10.100.0.0/22 IPs.  So those must be used for configuring
#client
  - "{{public_sone_address}}"
  - "{{ansible_external_ip}}"
  - 10.100.1.4
  - 10.100.1.5
  - 10.100.1.6
  - 10.100.1.7
  - 10.100.1.8
  - 10.100.1.9
  - 10.100.1.10

#Administrator email address and SMTP server through which
#administrator can be reached.  Used by OSSEC server to send emails.
admin_email_address: alerts@vlabs.ac.in

#SMTP smart host via which various servers can send email
#Set this to none if smtp_smart_host configuration is not required
smtp_smart_host: none

#DNS client configuration to configure DNS client on all machines
#after DNS server have been setup.  If DNS is not setup then setup these 
#values to none
private_dns_ips: none
private_dns_zone: none 
#private_dns_ips: 
#  - 10.100.1.5
#private_dns_zone: "{{prefix}}virtual-labs.ac.in {{prefix}}vlabs.ac.in"

#This variables is set to "yes" if the cluster is on AWS and "no" if
#cluster is on base machines so that it can be used in setting zones
#in named.conf of both DNS(public and private) roles
is_amazon: "yes"

#Rsyslog server IPs.  Set to none if there is no rsyslog server
rsyslog_server_ips:
  - 10.100.1.4

#IPs where router will forward web or DNS requests.
#Multiple IPs or list of IPs wont work as request can be forwarded to only one machine
ads_ip: 10.100.1.9
reverseproxy_ip: 10.100.1.7
public_dns_ip: 10.100.1.6
local_subnet: 10.100.0.0/22
router_interface_ip: "{{public_zone_address}}"
router_external_interface: eth0
#Used by bandwidthd, similar to base1 nomenclature 
router_internal_ip: 10.100.1.1

#Configure IP address of nagios server.  This is used by iptables firewall templates
nagios_server_ips:
  - 10.100.1.8

#Forwarders to be updated in Zone files
forwarders: "{ }"

#Used by private-dns ans public dns to set their zone file names



#List of domains to pass through reverseproxy
proxy_domains:
  - {domain: "reverseproxy.{{prefix}}virtual-labs.ac.in", alias: "reverseproxy.{{prefix}}vlabs.ac.in"}
  - {domain: "bandwidthd.{{prefix}}virtual-labs.ac.in", alias: "bandwidthd.{{prefix}}vlabs.ac.in"}

awstats_domains:
#  - cp."{{prefix}}"virtual-labs.ac.in


#AWS public DNS is also listing other public records of vlabs
public_dns_entries:
  - { hostname: router, ip: "{{public_zone_address}}" } 
  - { hostname: bandwidthd, ip: "{{public_zone_address}}" }
  - { hostname: ansible, ip: "{{ansible_external_ip}}"}
  - { hostname: ossec-server, ip: "{{public_zone_address}}" }
  - { hostname: rsyslog-server, ip: "{{public_zone_address}}" }
  - { hostname: private-dns, ip: "{{public_zone_address}}" }
  - { hostname: public-dns, ip: "{{public_zone_address}}" }
  - { hostname: reverseproxy, ip: "{{public_zone_address}}" }
  - { hostname: nagios, ip: "{{public_zone_address}}" }
  - { hostname: ads, ip: "{{public_zone_address}}" }
  - { hostname: rsnapshot-server, ip: "{{public_zone_address}}" }
#  - { hostname: cp, ip: "{{public_zone_address}}" }



private_dns_entries:
  - { hostname: router, ip: 10.100.1.1 }
  - { hostname: bandwidthd, ip: 10.100.1.1 }
  - { hostname: ansible, ip: 10.100.1.2 }
  - { hostname: ossec-server, ip: 10.100.1.3 }
  - { hostname: rsyslog-server, ip: 10.100.1.4 }
  - { hostname: private-dns, ip: 10.100.1.5 }
  - { hostname: public-dns, ip: 10.100.1.6 }
  - { hostname: reverseproxy, ip: 10.100.1.7 }
  - { hostname: nagios, ip: 10.100.1.8 }
  - { hostname: ads, ip: 10.100.1.9 }
  - { hostname: rsnapshot-server, ip: 10.100.1.10 }
#  - { hostname: cp, ip: 10.100.2.1 }

#+END_SRC


